# ğŸ—ï¸ Estructura Organizacional

## 3.1 ComposiciÃ³n de un Organismo Municipal

GDI organiza la estructura jerÃ¡rquica en **4 niveles principales** (segÃºn BD real):

```
MUNICIPALITY (Municipio)
â”œâ”€â”€ DEPARTMENTS (Reparticiones/SecretarÃ­as)
â”‚   â”œâ”€â”€ SECTORS (Sectores/Ãreas)
â”‚   â”‚   â””â”€â”€ USERS (Empleados/Funcionarios)
â”‚   â””â”€â”€ RANKS (Niveles JerÃ¡rquicos)
```

## 3.2 Niveles JerÃ¡rquicos

### ğŸ›ï¸ NIVEL 0: MUNICIPALITY (municipalities)

- **Nivel mÃ¡ximo** del sistema - soporta mÃºltiples municipios
- **Campos reales en BD**:
  - `id_municipality` (UUID)
  - `name` (nombre del municipio)
  - `acronym` (2-5 caracteres)
  - `country` (ENUM: AR, BR, UY, CL)
  - `schema_name` (esquema Ãºnico de BD)
  - `tax_identifier` (CUIT/identificador fiscal)
- **ConfiguraciÃ³n asociada**: `municipalities_settings` con logo, colores, etc.
- **Ejemplo**: Municipio de Terranova con acrÃ³nimo "TN", CUIT 30-12345678-9

### ğŸ¢ NIVEL 1: DEPARTMENT (departments)

- Representa las grandes Ã¡reas funcionales del municipio
- **Campos reales en BD**:
  - `department_id` (UUID)
  - `name` (ej: "SecretarÃ­a de Gobierno")
  - `acronym` (puede ser NULL para department raÃ­z)
  - `head_user_id` (UUID del titular - puede ser NULL)
  - `rank_id` (nivel jerÃ¡rquico asignado)
  - `parent_jurisdiction_id` (para crear sub-departments)
  - `municipality_id` (relaciÃ³n con municipality)
  - `is_active` (boolean)
  - `start_date`, `end_date` (vigencia temporal)
- **Ejemplo**: SecretarÃ­a de Hacienda (SECHAC) con Juan PÃ©rez como titular, rank nivel 8

### ğŸ“ NIVEL 2: SECTOR (sectors)

- Subdivisiones funcionales dentro de cada department
- **Campos reales en BD**:
  - `sector_id` (UUID)
  - `department_id` (UUID - relaciÃ³n con department)
  - `acronym` (2-10 caracteres mayÃºsculas)
  - `is_active` (boolean)
  - `start_date`, `end_date` (vigencia temporal)
- **Nota**: NO existe campo "name" en sectors (solo acronym)
- **Ejemplo**: Sector "MESA" (Mesa de Entrada) dentro de SecretarÃ­a de Gobierno

### ğŸ‘¤ NIVEL 3: USUARIO (users)

- Empleados y funcionarios municipales
- **Campos reales en BD**:
  - `user_id` (UUID)
  - `auth_id` (string - integraciÃ³n con Supabase Auth)
  - `full_name` (nombre completo)
  - `email` (Ãºnico en el sistema)
  - `cuit` (Ãºnico, puede ser NULL)
  - `sector_id` (UUID - UN solo sector por usuario)
  - `profile_picture_id` (referencia a media_files)
  - `is_active` (boolean)
  - `last_access` (timestamp)
  - `created_at` (timestamp)
- **Ejemplo**: MarÃ­a GonzÃ¡lez, CUIT 27-12345678-9, asignada al sector MESA

### ğŸ–ï¸ COMPONENTE: RANKS (ranks)

- Define niveles de autoridad y jerarquÃ­a
- **Campos reales en BD**:
  - `rank_id` (UUID)
  - `rank_name` (Ãºnico)
  - `head_signature` (texto de firma)
- **IntegraciÃ³n**: Se asigna a departments mediante `rank_id`
- **Ejemplo**: Rank "Secretario" (nivel 8), "Director" (nivel 6), "Coordinador" (nivel 4)

## 3.3 Entidades del Organigrama (REAL)

### 3.3.1 Entidad Usuario (users)

```
USUARIO (Tabla: users)
â”œâ”€â”€ IdentificaciÃ³n
â”‚   â”œâ”€â”€ user_id: UUID (PK)
â”‚   â”œâ”€â”€ auth_id: String (Ãºnico, integraciÃ³n Auth)
â”‚   â””â”€â”€ cuit: String (Ãºnico, opcional)
â”œâ”€â”€ Datos Personales
â”‚   â”œâ”€â”€ full_name: String (requerido)
â”‚   â”œâ”€â”€ email: String (Ãºnico, requerido)
â”‚   â””â”€â”€ profile_picture_id: UUID (opcional)
â”œâ”€â”€ UbicaciÃ³n Organizacional
â”‚   â”œâ”€â”€ sector_id: UUID (Sector OFICIAL - donde pertenece)
â”‚   â””â”€â”€ [user_sector_permissions]: Sectores donde COLABORA
â”œâ”€â”€ Estado
â”‚   â”œâ”€â”€ is_active: Boolean (default: true)
â”‚   â”œâ”€â”€ last_access: Timestamp
â”‚   â””â”€â”€ created_at: Timestamp
â””â”€â”€ Metadatos
    â”œâ”€â”€ identity_check: JSONB (validaciones)
    â””â”€â”€ audit_data: JSONB (auditorÃ­a)
```

**Ejemplo**: Usuario Juan PÃ©rez con sector_id apuntando a "SISTEMAS", pero con permisos adicionales en "MESA" y "LEGAL" mediante user_sector_permissions.

### 3.3.2 Entidad Department (departments)

```
DEPARTMENT (Tabla: departments)
â”œâ”€â”€ IdentificaciÃ³n
â”‚   â”œâ”€â”€ department_id: UUID (PK)
â”‚   â”œâ”€â”€ name: String (requerido)
â”‚   â””â”€â”€ acronym: String (opcional)
â”œâ”€â”€ JerarquÃ­a
â”‚   â”œâ”€â”€ parent_jurisdiction_id: UUID (auto-referencia)
â”‚   â”œâ”€â”€ rank_id: UUID (nivel jerÃ¡rquico)
â”‚   â””â”€â”€ municipality_id: UUID (municipio)
â”œâ”€â”€ Responsable
â”‚   â””â”€â”€ head_user_id: UUID (titular - puede ser NULL)
â”œâ”€â”€ Vigencia
â”‚   â”œâ”€â”€ is_active: Boolean (default: true)
â”‚   â”œâ”€â”€ start_date: Timestamp
â”‚   â””â”€â”€ end_date: Timestamp (opcional)
â””â”€â”€ Metadatos
    â””â”€â”€ audit_data: JSONB
```

**Ejemplo**: Department "SecretarÃ­a de ModernizaciÃ³n" con parent_jurisdiction_id NULL (es raÃ­z), head_user_id apuntando a Ana LÃ³pez.

### 3.3.3 Entidad Sector (sectors)

```
SECTOR (Tabla: sectors)
â”œâ”€â”€ IdentificaciÃ³n
â”‚   â”œâ”€â”€ sector_id: UUID (PK)
â”‚   â””â”€â”€ acronym: String (2-10 chars, mayÃºsculas)
â”œâ”€â”€ JerarquÃ­a
â”‚   â””â”€â”€ department_id: UUID (FK a departments)
â”œâ”€â”€ Vigencia
â”‚   â”œâ”€â”€ is_active: Boolean (default: true)
â”‚   â”œâ”€â”€ start_date: Timestamp
â”‚   â””â”€â”€ end_date: Timestamp (opcional)
â””â”€â”€ Metadatos
    â””â”€â”€ audit_data: JSONB
```

**Ejemplo**: Sector "CONT" (Contabilidad) con department_id apuntando a SecretarÃ­a de Hacienda.

## 3.4 Reglas de Negocio (Basadas en BD Real)

### ğŸ“‹ [RN001: ESTRUCTURA_JERÃRQUICA]
**ImplementaciÃ³n Real en BD:**
- âœ… Todo usuario tiene UN sector OFICIAL (`sector_id` en users)
- âœ… Un usuario puede COLABORAR en mÃºltiples sectores (`user_sector_permissions`)
- âœ… Todo sector pertenece a UN department (`department_id` en sectors)
- âœ… Un department puede tener mÃºltiples sectors
- âœ… Un sector puede tener mÃºltiples usuarios (oficiales y colaboradores)

**DistinciÃ³n importante:**
- **Sector Oficial**: Donde el usuario estÃ¡ asignado formalmente (`users.sector_id`)
  - *Ejemplo*: MarÃ­a estÃ¡ oficialmente en "Mesa de Entrada"
- **Sectores Colaborador**: Donde tiene permisos adicionales (`user_sector_permissions`)
  - *Ejemplo*: MarÃ­a tambiÃ©n colabora en "Sistemas" para soporte tÃ©cnico

### ğŸ‘‘ [RN002: TITULARIDAD]
**ImplementaciÃ³n Real en BD:**
- âœ… Cada department puede tener UN titular (`head_user_id`)
- âœ… Un usuario puede ser titular de mÃºltiples departments
- âš ï¸ El control de "solo titulares gestionan" debe implementarse en lÃ³gica de aplicaciÃ³n

**Ejemplo**: Carlos RodrÃ­guez es titular de "DirecciÃ³n de Compras" y tambiÃ©n de "DirecciÃ³n de Contrataciones" (dos head_user_id apuntan al mismo user_id).

### ğŸ”‘ [RN003: UNICIDAD]
**Constraints Reales en BD:**
- âœ… `users.cuit` - UNIQUE constraint
- âœ… `users.email` - UNIQUE constraint  
- âœ… `users.auth_id` - UNIQUE constraint
- âœ… `municipalities.acronym` - UNIQUE constraint
- âœ… `departments.acronym` - Sin constraint Ãºnico (puede repetirse)
- âœ… `sectors.acronym` - CHECK constraint (formato) pero no Ãºnico global

**Ejemplo**: No pueden existir dos usuarios con email "juan@municipio.gov", pero sÃ­ pueden existir dos departments con acronym "DIR" en diferentes municipios.

### ğŸ” [RN004: PERMISOS_GESTIÃ“N]
**ImplementaciÃ³n mediante RBAC:**
```sql
-- Sistema de permisos real
roles (role_id, role_name, description)
permissions (permission_id, name, description)
role_permissions (role_id, permission_id)
user_roles (user_id, role_id)
user_sector_permissions (user_id, sector_id)
```

**Ejemplo**: Usuario con rol "Administrador de ReparticiÃ³n" tiene permisos "crear_usuario", "modificar_sector", "ver_reportes".

## 3.5 Relaciones y Cardinalidades Reales

| RelaciÃ³n | Cardinalidad | ImplementaciÃ³n | Ejemplo |
|----------|--------------|----------------|---------|
| Municipality â†’ Departments | 1:N | `departments.municipality_id` | 1 municipio tiene 15 departments |
| Department â†’ Sectors | 1:N | `sectors.department_id` | SecretarÃ­a de Gobierno tiene 5 sectors |
| Sector â†’ Users (oficial) | 1:N | `users.sector_id` | Sector MESA tiene 10 usuarios asignados |
| Sector â†’ Users (colaborador) | N:N | `user_sector_permissions` | Juan colabora en MESA, SISTEMAS y LEGAL |
| Department â†’ Head User | N:1 | `departments.head_user_id` | Ana es titular de 2 departments |
| Department â†’ Rank | N:1 | `departments.rank_id` | 5 departments tienen rank "DirecciÃ³n" |
| User â†’ Roles | N:N | Tabla `user_roles` | MarÃ­a tiene roles "Agente" y "Auditor" |
| Role â†’ Permissions | N:N | Tabla `role_permissions` | Rol "Admin" tiene 20 permisos |

### ğŸ”„ Modelo de Pertenencia Dual:

1. **Pertenencia Oficial** (`users.sector_id`):
   - Cada usuario tiene UN sector oficial
   - Define su ubicaciÃ³n formal en la estructura
   - Determina su department principal
   - *Ejemplo*: Pedro pertenece oficialmente a "Recursos Humanos"

2. **ColaboraciÃ³n** (`user_sector_permissions`):
   - Usuario puede tener permisos en mÃºltiples sectores
   - Permite trabajo transversal entre Ã¡reas
   - Habilita colaboraciÃ³n sin cambiar pertenencia oficial
   - *Ejemplo*: Pedro colabora tambiÃ©n en "CapacitaciÃ³n" y "Bienestar Laboral"

## 3.6 Campos de Control Temporal

Todas las entidades organizacionales tienen control de vigencia:

- **`is_active`**: Estado actual (activo/inactivo)
- **`start_date`**: Fecha de inicio de vigencia
- **`end_date`**: Fecha de fin (NULL = vigente)
- **`audit_data`**: JSONB para auditorÃ­a de cambios

**Ejemplo**: Sector "TEMP2024" creado para proyecto especial con start_date='2024-01-01' y end_date='2024-12-31'.

---
